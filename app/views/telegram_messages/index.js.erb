$('#ajax-modal').html('<%= escape_javascript(render partial: 'modal_window') %>')

$('#ajax-modal').dialog({
  dialogClass: 'telegram-archive-modal',
  height: $(window).height(),
  width: '700px',
  modal: true,
  position: {
    my: "top",
    at: "top",
    of: window
  },
  resizable: false,
  title: 'Архив',
  open: function(){
    $("#datetimepicker").blur()
  },
  close: function(){
    $('#datetimepicker').datetimepicker('destroy')
  }
})

$('#datetimepicker').datetimepicker({
  validateOnBlur: false,
  format: "d.m.Y H:i",
  minDate: "<%= format_date @telegram_messages.first.sent_at %>",
  maxDate: "<%= format_date @telegram_messages.last.sent_at %>",
  formatDate: "d.m.Y",
  onSelectTime: function(time){
    var scrollTo = {}
    var container = $('.archive-form')
    var selectedUnixTime = time / 1000|0

    // find message to scroll
    $('.telegram-message').each(function(){
      var messageTime = $(this).data('sent-at')
      scrollTo = $(this)
      if (messageTime > selectedUnixTime) {
        return false
      }
    })

    container.animate({scrollTop: scrollTo.offset().top - container.offset().top +
                      container.scrollTop()})
  }
})

var formHeight = $('#ajax-modal').css('height').match(/\d+/)[0] - 75
$('.archive-form').css({
  height: formHeight
})

$(".telegram-message").click(function(){
  if ($(this).hasClass("telegram-selected-message")) {
    $(this).removeClass("telegram-selected-message")
    $(this).find(".telegram-message-checkbox").prop("checked", false);
  } else {
    $(this).addClass("telegram-selected-message")
    $(this).find(".telegram-message-checkbox").prop("checked", true);
  }
})

$(".telegram-message").hover(function(){
  $(this).find(".telegram-message-checkbox").css("visibility", "visible");
}, function(){
  if (!$(this).hasClass("telegram-selected-message")) {
    $(this).find(".telegram-message-checkbox").css("visibility", "hidden");
  }
})


// Search
var messages = $("#telegram-search-input").data("messages")

var searchOptions = {
  caseSensitive: false,
  tokenize: true,
  threshold: 0.0,
  location: 0,
  distance: 10000,
  maxPatternLength: 32,
  keys: ["message"]
};

var fuse = new Fuse(messages, searchOptions);

$("#telegram-search-input").keyup(function(event){
  query = event.target.value
  if (query){
    $(".archive-form").children().hide()

    matchedMessages = fuse.search(query)
    matchedMessages.forEach(function(message){
      var regexp = "^" + query + "| " + query
      highlightedMessageText = message.message.replace(new RegExp(regexp, "ig"), '<strong>$&</strong>')
      if (!message['is_system']){
        $("#telegram_message_" + message.id)
        .show()
        .find(".telegram-message-text").html(highlightedMessageText)
      }
    })
  } else {
    $(".archive-form").children().show()
    messages.forEach(function(message){
      if (!message['is_system']){
        $("#telegram_message_" + message.id)
        .show()
        .find(".telegram-message-text").html(message.message)
      }
    })
  }
})
