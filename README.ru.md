# redmine_chat_telegram

[English version](https://github.com/centosadmin/redmine_chat_telegram/blob/master/README.md)

Плагин разработан в компании [Centos-admin.ru](https://centos-admin.ru)

[Описание плагина на habrahabr.ru](https://habrahabr.ru/company/centosadmin/blog/281044/)

Плагин для Redmine для создания групповых чатов в Telegram.

Плагин `redmine_chat_telegram` используется для создания группового чата, связанного с тикетом, и записи его логов в архиве Redmine. Связанные групповые чаты могут легко быть созданы с помощью ссылки "Создать чат Telegram", которая появится на странице тикета. Вы сможете скопировать ссылку и передать её любому, кого Вы захотите подключить к этому чату.

![Create telegram chat](https://github.com/centosadmin/redmine_chat_telegram/raw/master/assets/images/create-link.png)
![Chat links](https://github.com/centosadmin/redmine_chat_telegram/raw/master/assets/images/chat-links.png)

Пожалуйста помогите нам сделать этот плагин лучше, сообщая во вкладке [Issues](https://github.com/centosadmin/redmine_chat_telegram/issues) обо всех проблемах, с которыми Вы столкнётесь при его использовании. Мы готовы ответить на Все ваши вопросы, касающиеся этого плагина.

## Установка

### Требования

* **Ruby 2.3+**
* [redmine_telegram_common](https://github.com/centosadmin/redmine_telegram_common)
* [Telegram CLI](https://github.com/vysheng/tg) должен быть установлен
* У Вас должен быть аккаунт пользователя Telegram
* У Вас должен быть аккаунт для создания ботов в Telegram
* Плагин [redmine_sidekiq](https://github.com/ogom/redmine_sidekiq) должен быть установлен
* Sidekiq должен обрабатывать очереди `default` и `telegram`. [Пример конфига](https://github.com/centosadmin/redmine_intouch/blob/master/tools/sidekiq.yml) - разместите его в папке `redmine/config`
* Не забудьте запустить миграции `bundle exec rake redmine:plugins:migrate RAILS_ENV=production`

### Конфигурация в Telegram CLI

**!!! ВНИМАНИЕ !!!** 

Начиная с версии 1.4.5, в плагине используется обращение к Telegram CLI как к службе.

В связи с этим `telegram-cli` должен быть запущен как служба.

В каталоге `extras` вы можете найти:
* пример скрипта `init.d`
* пример конфига для `monit`

### Первый запуск

Запустите `telegram-cli` на Вашем сервере Redmine и залогиньтесь через него в Telegram. После этого Вы сможете создавать групповые чаты.

### Создание бота в Telegram

Необходимо создать нового бота и получить его токен. 
Для этого в Telegram используется [@BotFather](https://telegram.me/botfather). 
Наберите `start` для получения полного списка предоставляемых им команд.

Наберите `/newbot` для регистрации нового бота. @BotFather спросит у Вас имя нового бота. Имя бота должно оканчиваться на "bot".

При успешной регистрации @BotFather даст вам токен Вашего нового бота, а также ссылку для того, чтобы Вы могли быстро добавить его в Ваш список контактов. Вам придётся придумать новое имя если регистрация не удастся.

Установите Privacy mode в disabled с помощью команды `/setprivacy`. Это позволит боту слушать групповой чат и добавлять его логи в архив чатов Redmine.

Введите токен бота на странице Plugin Settings для того чтобы добавить бота в ваш чат.

Чтобы добавить подсказки команд для бота, используйте команду `/setcommands`. Нужно написать боту список команд с описанием. Этот список вы можете получить из команды `/help`


### Добавление бота в список контактов

Наберите `/start` для вашего бота под своим аккаунтом.
Это позволит пользователю добавить бота в групповой чат.

### Запуск бота

Запустите `telegram-cli` используя скрип `init`. Пример можно посмотреть в папке `extras`.

Для запуска бота выполните следующее rake задание:

```shell
bundle exec rake chat_telegram:bot PID_DIR='/pid/dir'
```

### Синхронизация архива

Плагие не записывает сообщения чата в архив когда он остановлен. Во избежание потери сообщений плагин выполяет синхноризацию сообщений из чата в архив при следующем запуске с задержкой в 5 минут.

## Использование

Откройте тикет. Справа на странице Вы увидите ссылку `создать чат Telegram`. Щёлкните по ней и Вы создадите групповой чат в Telegram, который будет связан с этим тикетом. Ссылка изменится на `Войти в чат Telegram`. Щёлкните на ней чтобы присоединиться к чату, открыв его в своём клиенте Telegram. Вы сможете скопировать и передать ссылку любому кому захотите для того, чтобы он смог присоединиться к этому групповому чату.

### Доступные команды в чате с ботом

- `/connect account@redmine.com` - связать аккаунт Telegram и Redmine
- `/new` - команда для создания новой задачи
- `/cancel` - отмена текущей команды

### Доступные команды в чате задачи

- `/task`, `/link`, `/url` - получение ссылки задачи
- `/log` - сохраняет сообщение в задачу

#### Подсказки для команд бота

Чтобы добавить подсказки команд для бота, используйте команду `/setcommands` в беседе с [@BotFather](https://telegram.me/botfather). Нужно написать боту список команд с 
описанием:

```
start - начало работы с ботом
connect - связать аккаунты Telegram и Redmine
new - создать новую задачу
hot - назначенные вам задачи, обновленные за последние сутки
me -  назначенные вам задачи
deadline - назначенные вам задачи с просроченным дедлайном
spent - количество проставленного времени за текущие сутки
yspent - количество проставленного времени за вчерашние сутки
last - последние 5 задач с последними комментариями
help - помощь по командам
chat - управления чатами задач.
help - справка по командам
task - получить ссылку на задачу
link - получить ссылку на задачу
url - получить ссылку на задачу
log - сохранить сообщение в задачу (укажите команду в любом месте сообщения)
issue - редактирование задач
```

### Автоматическое закрытие чата при закрытии задачи

После закрытия задачи, чат закроется через 2 недели автоматически.

За 1 неделю до закрытия каждые 12 часов в чат будет приходить сообщение:
"Задача по этому чату закрыта. Чат будет автоматически расформирован через XX дней."

По истечении времени все участники чата будут удалены из него.

## Возможные проблемы

### При создании чата ссылка на чат содержит FAILED

Попробуйте сменить `telegram_cli_mode` в `telegram.yml` на `1`.

### Couldn't open public key file: tg-server.pub

Это баг в Telegram CLI. Мы направили [pull request](https://github.com/Rondoozle/tg/pull/4) с решением.

Временное решение: расположите файл `tg-server.pub` в корневом каталоге Redmine.  
